<!DOCTYPE html>
<html>
<head>
<title>The MSD Book :: Command Pattern</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="command-pattern--deep-dive-practical-plain-useful">Command pattern — deep dive (practical, plain, useful)</h1>
<p>
    <img src="msd-book-front.png" 
    alt="The MSD Book" width="200" style="float: left; margin: 0 1rem 1rem 0;"/>
    Short version: the <strong>Command</strong> pattern turns requests into first-class objects. That gives you decoupling between <em>who</em> asks for an action and <em>how</em> the action is performed. It enables queuing, undo/redo, logging/replay, remote execution, macros, and testability.</p>
<hr>
<h1 id="why-use-command">Why use Command?</h1>
<ul>
<li><strong>Decoupling</strong> — caller (Invoker) only needs an interface to call <code>Execute()</code>. It doesn't need the Receiver details.</li>
<li><strong>Composition &amp; Macros</strong> — commands can be composed into macro-commands.</li>
<li><strong>Undo/Redo</strong> — commands can store state needed to undo.</li>
<li><strong>Queueing / Retry / Scheduling</strong> — commands are objects you can serialize, queue, retry, or send across processes.</li>
<li><strong>Logging &amp; Replay</strong> — persist commands to replay actions (useful for auditing or event-sourcing patterns).</li>
<li><strong>Testability</strong> — commands are small units that can be unit tested in isolation.</li>
<li><strong>Responsibility segregation</strong> — moves action behavior into small classes instead of huge service methods.</li>
</ul>
<p>Tradeoffs: more classes, slightly more boilerplate. Use when benefits (above) outweigh cost.</p>
<hr>
<h1 id="where-to-apply-practical-rules">Where to apply (practical rules)</h1>
<p>Apply when any of these are true:</p>
<ul>
<li>You need <strong>undo/redo</strong> or audit logs.</li>
<li>You must <strong>queue, schedule, retry, or distribute</strong> work (e.g., background workers).</li>
<li>You want to <strong>decouple UI/controller from domain actions</strong> (especially in rich clients).</li>
<li>You need clear <strong>separation of concerns</strong>: request description vs execution.</li>
<li>You want <strong>macro operations</strong> built from smaller operations.</li>
</ul>
<p>Avoid over-using it for tiny, single-shot operations where a method call is simpler.</p>
<hr>
<h1 id="example-before--after-c-console-app--ready-to-run">Example: Before &amp; After (C# console app — ready to run)</h1>
<p>We'll start with a small e-commerce-like module where a controller directly performs operations on an <code>OrderService</code>. The before code mixes controller/invoker logic with service logic and makes undo, logging, and queuing harder.</p>
<p>Then refactor to the Command pattern with:</p>
<ul>
<li><code>ICommand</code> interface</li>
<li><code>CreateOrderCommand</code>, <code>CancelOrderCommand</code>, <code>AddItemCommand</code></li>
<li><code>Invoker</code> (keeps history for undo)</li>
<li><code>MacroCommand</code> and a simple <code>QueueProcessor</code> example</li>
</ul>
<p>Both code blocks are full programs you can paste into a <code>.cs</code> file and run with <code>dotnet run</code> (targeting .NET 6+).</p>
<hr>
<h2 id="before--procedural--direct-call-tight-coupling">BEFORE — procedural / direct call (tight coupling)</h2>
<pre class="hljs"><code><div><span class="hljs-comment">// File: Before.cs</span>
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">BeforeExample</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Order</span>
    {
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; } = Guid.NewGuid();
        <span class="hljs-keyword">public</span> List&lt;<span class="hljs-keyword">string</span>&gt; Items { <span class="hljs-keyword">get</span>; } = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-keyword">string</span>&gt;();
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsCancelled { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Cancel</span>(<span class="hljs-params"></span>)</span> =&gt; IsCancelled = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrderService</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Dictionary&lt;Guid, Order&gt; _orders = <span class="hljs-keyword">new</span>();

        <span class="hljs-function"><span class="hljs-keyword">public</span> Order <span class="hljs-title">CreateOrder</span>(<span class="hljs-params"></span>)</span> {
            <span class="hljs-keyword">var</span> o = <span class="hljs-keyword">new</span> Order();
            _orders[o.Id] = o;
            Console.WriteLine(<span class="hljs-string">$"Order <span class="hljs-subst">{o.Id}</span> created."</span>);
            <span class="hljs-keyword">return</span> o;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddItem</span>(<span class="hljs-params">Guid orderId, <span class="hljs-keyword">string</span> item</span>)</span> {
            <span class="hljs-keyword">if</span> (_orders.TryGetValue(orderId, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> o) &amp;&amp; !o.IsCancelled) {
                o.Items.Add(item);
                Console.WriteLine(<span class="hljs-string">$"Added '<span class="hljs-subst">{item}</span>' to <span class="hljs-subst">{orderId}</span>."</span>);
            } <span class="hljs-keyword">else</span> {
                Console.WriteLine(<span class="hljs-string">"Order not found or cancelled."</span>);
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CancelOrder</span>(<span class="hljs-params">Guid orderId</span>)</span> {
            <span class="hljs-keyword">if</span> (_orders.TryGetValue(orderId, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> o)) {
                o.Cancel();
                Console.WriteLine(<span class="hljs-string">$"Order <span class="hljs-subst">{orderId}</span> cancelled."</span>);
            } <span class="hljs-keyword">else</span> {
                Console.WriteLine(<span class="hljs-string">"Order not found."</span>);
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Controller</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> OrderService _svc = <span class="hljs-keyword">new</span>();

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">var</span> order = _svc.CreateOrder();
            _svc.AddItem(order.Id, <span class="hljs-string">"Widget A"</span>);
            _svc.AddItem(order.Id, <span class="hljs-string">"Widget B"</span>);
            _svc.CancelOrder(order.Id);
            <span class="hljs-comment">// Hard to queue, undo, log, or compose without modifying OrderService</span>
        }
    }

    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">new</span> Controller().Run();
        }
    }
}
</div></code></pre>
<p>Problems:</p>
<ul>
<li>Controller must know service methods and order IDs.</li>
<li>No easy undo.</li>
<li>Hard to queue or persist actions.</li>
</ul>
<hr>
<h2 id="after--command-pattern-decoupled-testable-undoqueue-ready">AFTER — Command pattern (decoupled, testable, undo/queue ready)</h2>
<pre class="hljs"><code><div><span class="hljs-comment">// File: After.cs</span>
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AfterExample</span>
{
    <span class="hljs-comment">// 1) Command interface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ICommand</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Execute</span>(<span class="hljs-params"></span>)</span>;
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Undo</span>(<span class="hljs-params"></span>)</span>; <span class="hljs-comment">// optional for undo support</span>
    }

    <span class="hljs-comment">// 2) Receiver(s)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Order</span>
    {
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; } = Guid.NewGuid();
        <span class="hljs-keyword">public</span> List&lt;<span class="hljs-keyword">string</span>&gt; Items { <span class="hljs-keyword">get</span>; } = <span class="hljs-keyword">new</span>();
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsCancelled { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddItem</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> item</span>)</span> =&gt; Items.Add(item);
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Cancel</span>(<span class="hljs-params"></span>)</span> =&gt; IsCancelled = <span class="hljs-literal">true</span>;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RestoreCancel</span>(<span class="hljs-params"></span>)</span> =&gt; IsCancelled = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrderRepository</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Dictionary&lt;Guid, Order&gt; _orders = <span class="hljs-keyword">new</span>();
        <span class="hljs-function"><span class="hljs-keyword">public</span> Order <span class="hljs-title">Create</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">var</span> o = <span class="hljs-keyword">new</span> Order();
            _orders[o.Id] = o;
            <span class="hljs-keyword">return</span> o;
        }

        <span class="hljs-keyword">public</span> Order? Get(Guid id) =&gt; _orders.TryGetValue(id, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> o) ? o : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 3) Concrete Commands</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CreateOrderCommand</span> : <span class="hljs-title">ICommand</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> OrderRepository _repo;
        <span class="hljs-keyword">public</span> Guid? OrderId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CreateOrderCommand</span>(<span class="hljs-params">OrderRepository repo</span>)</span> =&gt; _repo = repo;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Execute</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">var</span> order = _repo.Create();
            OrderId = order.Id;
            Console.WriteLine(<span class="hljs-string">$"[CreateOrder] Created <span class="hljs-subst">{OrderId}</span>"</span>);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Undo</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-comment">// For demo, we won't implement delete; in real system you'd mark or remove</span>
            Console.WriteLine(<span class="hljs-string">$"[CreateOrder] Undo is a no-op in this simple demo (would delete or mark as rolled back)."</span>);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AddItemCommand</span> : <span class="hljs-title">ICommand</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> OrderRepository _repo;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Guid _orderId;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">string</span> _item;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> _executed;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AddItemCommand</span>(<span class="hljs-params">OrderRepository repo, Guid orderId, <span class="hljs-keyword">string</span> item</span>)</span>
        {
            _repo = repo;
            _orderId = orderId;
            _item = item;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Execute</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">var</span> order = _repo.Get(_orderId);
            <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span> || order.IsCancelled)
            {
                Console.WriteLine(<span class="hljs-string">"[AddItem] Order not available."</span>);
                <span class="hljs-keyword">return</span>;
            }
            order.AddItem(_item);
            _executed = <span class="hljs-literal">true</span>;
            Console.WriteLine(<span class="hljs-string">$"[AddItem] Added '<span class="hljs-subst">{_item}</span>' to <span class="hljs-subst">{_orderId}</span>"</span>);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Undo</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">if</span> (!_executed) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">var</span> order = _repo.Get(_orderId);
            <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>)
            {
                <span class="hljs-comment">// naive undo: remove last matching item</span>
                order.Items.Remove(_item);
                Console.WriteLine(<span class="hljs-string">$"[AddItem] Undo removed '<span class="hljs-subst">{_item}</span>' from <span class="hljs-subst">{_orderId}</span>"</span>);
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CancelOrderCommand</span> : <span class="hljs-title">ICommand</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> OrderRepository _repo;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Guid _orderId;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> _executed;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CancelOrderCommand</span>(<span class="hljs-params">OrderRepository repo, Guid orderId</span>)</span>
        {
            _repo = repo;
            _orderId = orderId;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Execute</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">var</span> order = _repo.Get(_orderId);
            <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) { Console.WriteLine(<span class="hljs-string">"[Cancel] Order not found."</span>); <span class="hljs-keyword">return</span>; }
            order.Cancel();
            _executed = <span class="hljs-literal">true</span>;
            Console.WriteLine(<span class="hljs-string">$"[Cancel] Cancelled <span class="hljs-subst">{_orderId}</span>"</span>);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Undo</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">if</span> (!_executed) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">var</span> order = _repo.Get(_orderId);
            <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>)
            {
                order.RestoreCancel();
                Console.WriteLine(<span class="hljs-string">$"[Cancel] Undo restored <span class="hljs-subst">{_orderId}</span>"</span>);
            }
        }
    }

    <span class="hljs-comment">// 4) Macro: composite command</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MacroCommand</span> : <span class="hljs-title">ICommand</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> List&lt;ICommand&gt; _commands = <span class="hljs-keyword">new</span>();
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params">ICommand cmd</span>)</span> =&gt; _commands.Add(cmd);
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Execute</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> c <span class="hljs-keyword">in</span> _commands) c.Execute();
        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Undo</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = _commands.Count - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) _commands[i].Undo();
        }
    }

    <span class="hljs-comment">// 5) Invoker (keeps history for undo, can dispatch, queue, schedule)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Invoker</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Stack&lt;ICommand&gt; _history = <span class="hljs-keyword">new</span>();

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ExecuteCommand</span>(<span class="hljs-params">ICommand cmd, <span class="hljs-keyword">bool</span> pushToHistory = <span class="hljs-literal">true</span></span>)</span>
        {
            cmd.Execute();
            <span class="hljs-keyword">if</span> (pushToHistory) _history.Push(cmd);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UndoLast</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">if</span> (_history.Count == <span class="hljs-number">0</span>) { Console.WriteLine(<span class="hljs-string">"Nothing to undo."</span>); <span class="hljs-keyword">return</span>; }
            <span class="hljs-keyword">var</span> cmd = _history.Pop();
            cmd.Undo();
        }
    }

    <span class="hljs-comment">// 6) Example queue processor (simple)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CommandQueue</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Queue&lt;ICommand&gt; _queue = <span class="hljs-keyword">new</span>();
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Enqueue</span>(<span class="hljs-params">ICommand c</span>)</span> =&gt; _queue.Enqueue(c);
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessAll</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">while</span> (_queue.Count &gt; <span class="hljs-number">0</span>)
            {
                <span class="hljs-keyword">var</span> c = _queue.Dequeue();
                c.Execute();
            }
        }
    }

    <span class="hljs-comment">// 7) Example usage wiring everything together</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">var</span> repo = <span class="hljs-keyword">new</span> OrderRepository();
            <span class="hljs-keyword">var</span> invoker = <span class="hljs-keyword">new</span> Invoker();

            <span class="hljs-comment">// Create order</span>
            <span class="hljs-keyword">var</span> createCmd = <span class="hljs-keyword">new</span> CreateOrderCommand(repo);
            invoker.ExecuteCommand(createCmd);
            <span class="hljs-keyword">var</span> orderId = createCmd.OrderId ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException();

            <span class="hljs-comment">// Add items via commands</span>
            invoker.ExecuteCommand(<span class="hljs-keyword">new</span> AddItemCommand(repo, orderId, <span class="hljs-string">"Widget A"</span>));
            invoker.ExecuteCommand(<span class="hljs-keyword">new</span> AddItemCommand(repo, orderId, <span class="hljs-string">"Widget B"</span>));

            <span class="hljs-comment">// Undo last add</span>
            invoker.UndoLast(); <span class="hljs-comment">// will undo adding "Widget B"</span>

            <span class="hljs-comment">// Cancel order</span>
            invoker.ExecuteCommand(<span class="hljs-keyword">new</span> CancelOrderCommand(repo, orderId));

            <span class="hljs-comment">// Undo cancel</span>
            invoker.UndoLast(); <span class="hljs-comment">// will restore cancel</span>

            Console.WriteLine(<span class="hljs-string">"--- Macro example: create order + add two items ---"</span>);
            <span class="hljs-keyword">var</span> macro = <span class="hljs-keyword">new</span> MacroCommand();
            <span class="hljs-keyword">var</span> create2 = <span class="hljs-keyword">new</span> CreateOrderCommand(repo);
            macro.Add(create2);
            <span class="hljs-comment">// note: create2 must be executed first to get Id; in complex scenarios commands might accept placeholders or factories</span>
            macro.Add(<span class="hljs-keyword">new</span> AddItemCommand(repo, create2.OrderId ?? Guid.Empty, <span class="hljs-string">"X"</span>)); <span class="hljs-comment">// here will be empty — for demo only</span>
            <span class="hljs-comment">// Real macro construction would either be built after creation or use deferred resolution. This demonstrates composition.</span>

            <span class="hljs-comment">// Simple queue example</span>
            <span class="hljs-keyword">var</span> queue = <span class="hljs-keyword">new</span> CommandQueue();
            <span class="hljs-keyword">var</span> createCmdQ = <span class="hljs-keyword">new</span> CreateOrderCommand(repo);
            queue.Enqueue(createCmdQ);
            queue.Enqueue(<span class="hljs-keyword">new</span> CreateOrderCommand(repo));
            queue.ProcessAll();

            Console.WriteLine(<span class="hljs-string">"Done."</span>);
        }
    }
}
</div></code></pre>
<p>Notes about the refactor:</p>
<ul>
<li>Every action is a command object implementing <code>ICommand</code>.</li>
<li><code>Invoker</code> executes commands and optionally keeps history for undo.</li>
<li><code>CommandQueue</code> can be persisted or processed by workers.</li>
<li><code>MacroCommand</code> composes operations.</li>
<li>Undo implementations in commands are <strong>domain-specific</strong> — only commands that can reasonably be undone should implement meaningful <code>Undo</code>. In larger systems, you may separate <code>IReversibleCommand</code> or similar.</li>
</ul>
<hr>
<h1 id="practical-tips-for-production-use">Practical tips for production use</h1>
<ol>
<li>
<p><strong>Interfaces &amp; Separation</strong></p>
<ul>
<li>Keep a small <code>ICommand</code> (e.g., <code>Execute()</code>), and optionally a separate <code>IUndoableCommand : ICommand</code> with <code>Undo()</code>.</li>
<li>Keep command construction (wiring dependencies like repositories) in factories or DI container.</li>
</ul>
</li>
<li>
<p><strong>Serialization</strong></p>
<ul>
<li>For queuing or persistence, keep commands DTO-like (data + command type). Avoid serializing live objects with closures. Use a mapper: command DTO -&gt; concrete command instance.</li>
</ul>
</li>
<li>
<p><strong>Idempotency</strong></p>
<ul>
<li>Commands processed by background workers should be idempotent (or have deduplication) to handle retries.</li>
</ul>
</li>
<li>
<p><strong>Retry / Error handling</strong></p>
<ul>
<li>Wrap command execution with error handling, retries, and poison queue handling.</li>
</ul>
</li>
<li>
<p><strong>Logging / Auditing</strong></p>
<ul>
<li>Log the command type and parameters, not internal object references. That allows replay.</li>
</ul>
</li>
<li>
<p><strong>Testing</strong></p>
<ul>
<li>Test commands in isolation using fakes for repositories or using in-memory repositories.</li>
</ul>
</li>
<li>
<p><strong>Undo complexity</strong></p>
<ul>
<li>Undo is not always feasible for external side-effects (payments, emails). Design carefully or adopt compensating actions.</li>
</ul>
</li>
</ol>
<hr>
<h1 id="lint-style-checklist-for-code-reviews-quick-copyable">Lint-style checklist for code reviews (quick, copyable)</h1>
<ul>
<li><input type="checkbox" id="checkbox0"><label for="checkbox0"></label><strong>Single responsibility:</strong> Command classes do one action; no business logic spread across invoker/UI.</li>
<li><input type="checkbox" id="checkbox1"><label for="checkbox1"></label><strong>Small interface:</strong> <code>ICommand</code> remains minimal (e.g., <code>Execute()</code> only). Use <code>IUndoableCommand</code> for undo.</li>
<li><input type="checkbox" id="checkbox2"><label for="checkbox2"></label><strong>No direct side effects in constructor:</strong> Commands should not execute work in constructors.</li>
<li><input type="checkbox" id="checkbox3"><label for="checkbox3"></label><strong>Dependencies injected, not created inside the command:</strong> Commands should accept repositories/services via constructor injection.</li>
<li><input type="checkbox" id="checkbox4"><label for="checkbox4"></label><strong>Serializable payload:</strong> If command will be queued or persisted, confirm command has a serializable DTO (no closures or complex runtime-only references).</li>
<li><input type="checkbox" id="checkbox5"><label for="checkbox5"></label><strong>Idempotent or dedup-safe:</strong> Commands intended for background processing are idempotent or have deduplication keys.</li>
<li><input type="checkbox" id="checkbox6"><label for="checkbox6"></label><strong>Clear undo semantics:</strong> If <code>Undo()</code> is provided, verify it correctly restores a consistent state or provide a compensating action.</li>
<li><input type="checkbox" id="checkbox7"><label for="checkbox7"></label><strong>Proper error handling:</strong> Invoker or executor handles exceptions (retries, backoff, dead-letter).</li>
<li><input type="checkbox" id="checkbox8"><label for="checkbox8"></label><strong>No business logic in Invoker/UI:</strong> Invoker should call commands; it should not contain domain rules.</li>
<li><input type="checkbox" id="checkbox9"><label for="checkbox9"></label><strong>Logging/Audit info present:</strong> Commands log sufficient information (type + parameters) for debugging/replay.</li>
<li><input type="checkbox" id="checkbox10"><label for="checkbox10"></label><strong>Unit tested:</strong> Each command has unit tests that verify <code>Execute()</code> and, if applicable, <code>Undo()</code>.</li>
<li><input type="checkbox" id="checkbox11"><label for="checkbox11"></label><strong>Composition safe:</strong> Macro commands iterate commands in the correct order and undo in reverse order.</li>
<li><input type="checkbox" id="checkbox12"><label for="checkbox12"></label><strong>Respect transactional boundaries:</strong> Long-running commands should not hold DB transactions open across external calls.</li>
<li><input type="checkbox" id="checkbox13"><label for="checkbox13"></label><strong>Performance:</strong> Verify creating many command objects does not create GC or memory pressure in hot paths; prefer pooling or batching if necessary.</li>
</ul>
<hr>
<h1 id="short-patterns--variants-to-consider">Short patterns &amp; variants to consider</h1>
<ul>
<li><strong>Simple Command:</strong> <code>ICommand.Execute()</code> — basic decoupling.</li>
<li><strong>Undoable Command:</strong> <code>IUndoableCommand</code> with <code>Undo()</code>.</li>
<li><strong>Parameterized Commands / Factories:</strong> Use small DTOs and command factories to build concrete commands.</li>
<li><strong>Composite/Macro:</strong> <code>CompositeCommand</code> for grouping.</li>
<li><strong>Queued Commands:</strong> Map DTO -&gt; command instance at worker time; store metadata (attempts, correlation id).</li>
<li><strong>Command Handler + Mediator:</strong> Alternative style used widely (e.g., CQRS) where a <code>ICommand</code> is a marker and separate <code>ICommandHandler&lt;T&gt;</code> does the work. Helps with DI and single-responsibility in large systems.</li>
<li><strong>Event-sourcing variant:</strong> Commands produce events persisted to an event store.</li>
</ul>
<hr>
<h1 id="closing--quick-checklist-to-decide-to-use-it">Closing / quick checklist to decide to use it</h1>
<p>Use Command when you want <em>plasticity</em> of actions — to queue, undo, log, compose, or test them separately. If your actions are simple CRUD operations invoked synchronously and never need replay or undo, a straightforward service method is fine.</p>
<hr>
<p><strong>NOTE:</strong> This page is generated with assistance from AI tools.</p>

</body>
</html>
